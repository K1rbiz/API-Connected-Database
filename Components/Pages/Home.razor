@page "/"
@using API_Connected_Database.Models
@inject API_Connected_Database.Services.ICatFactsService Api
@inject API_Connected_Database.Services.ICatFactsRepository Repo

<h3>API Connected Database – Cat Facts</h3>

<!-- Added the buttons -->
<div style="margin-bottom:0.75rem;">
    <input type="number" min="1" max="20" @bind="limit" style="width:80px;" />
    <button @onclick="FetchAndSaveAsync" style="margin-left:6px;">Fetch and Save Data</button>
    <button @onclick="ClearAsync" style="margin-left:6px;">Clear DB</button>
</div>

@if (isBusy)
{
    <p>Working...</p>
}
else if (!string.IsNullOrWhiteSpace(error))
{
    <p style="color:red">@error</p>
}
else if (facts?.Count > 0)
{
    <ul>
        @foreach (var f in facts)
        {
            <li>@f.fact (@f.length characters)</li>
        }
    </ul>
}
else
{
    <p>No data yet.</p>
}

@code {
    // State variables
    private List<CatFact> facts = new();
    private bool isBusy;
    private string? error;
    private int limit = 5;

    // Lifecycle method to load data from the database on initialization
    protected override async Task OnInitializedAsync()
    {
        await Repo.InitAsync(); // Ensure the database is initialized
        await LoadFromDbAsync(); // Load existing data from the database
    }

    // Method to fetch data from the API and save it to the database
    private async Task FetchAndSaveAsync()
    {
        isBusy = true; error = null; StateHasChanged(); // Update UI immediately
        try
        {
            var fetched = await Api.GetCatFactsAsync(limit); // Fetch data from the API
            await Repo.InsertAllAsync(fetched); // Save fetched data to the database
            facts = await Repo.GetAllAsync(); // Reload data from the database
        }
        catch (Exception ex){ error = ex.Message; } // Handle any errors
        finally { isBusy = false; } // Ensure isBusy is reset
    }

    // Method to load data from the database
    private async Task LoadFromDbAsync()
    {
        isBusy = true; error = null; StateHasChanged(); // Update UI immediately
        try
        {
            facts = await Repo.GetAllAsync(); // Load data from the database
        }
        catch (Exception ex) { error = ex.Message; } // Handle any errors
        finally { isBusy = false; }
    }

    // Method to clear all data from the database
    private async Task ClearAsync()
    {
        await Repo.ClearAsync(); // Clear all data from the database
        facts.Clear(); // Clear the local list
    }
}
